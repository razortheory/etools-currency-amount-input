<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">

<!--
`etools-currency-input`


@demo demo/index.html 
-->

<dom-module id="etools-currency-input">

  <template>
    <style>
      :host {
        width: 235px;
        @apply(--etools-currency-input);
      }

      *[hidden] {
        display: none !important;
      }

      /* TODO: Find a way to separate readonly CSS from shared-styles, and use it here,
      then include it in shared-styles(do not use shared-styles here) */
    </style>

    <paper-input id="currencyInput"
                 label="[[label]]"
                 value="{{internalValue}}"
                 allowed-pattern="[0-9\.\,]"
                 placeholder="[[placeholder]]"
                 disabled$="[[disabled]]"
                 readonly$="[[readonly]]"
                 required$="[[required]]"
                 invalid$="[[invalid]]"
                 auto-validate$="[[autoValidate]]"
                 error-message="[[errorMessage]]">
      <div prefix class="prefix" hidden$=[[!currency]]>[[currency]]</div>
    </paper-input>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'etools-currency-input',
        properties: {
          label: String,
          internalValue: {
            type: String,
            observer: '_applyCurrencyFormat'
          },
          value: {
            value: null,
            notify: true,
            observer: '_valueChanged'
          },
          placeholder: {
            type: String,
            value: 'â€”'
          },
          readonly: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: '_readonlyStateChange'
          },
          disabled: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
          },
          required: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          autoValidate: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          invalid: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          errorMessage: {
            type: String,
            value: 'This field is required'
          },
          currency: String
        },

        _readonlyStateChange: function(newValue, oldValue) {
          if (newValue !== oldValue) {
            this.updateStyles();
          }
        },

        validate: function() {
          return this.$.currencyInput.validate();
        },

        _valueChanged: function(value) {
          if (this._getRealNumberValue(value) === this._getRealNumberValue(this.internalValue)) {
            // value and internal value are equal; do nothing
            return;
          }
          // format value as currency amount and set it as internal value
          var val = this._formatNumber(value);
          this.set('internalValue', val);
          console.log('value changed: ', value, this.internalValue);
        },
        _formatNumber: function(numStr) {
          if (this._emptyValue(numStr)) {
            return '0';
          }
          numStr = parseFloat(numStr).toFixed(2);
          numStr += '';
          return numStr.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1, ');
        },
        _getRealNumberValue: function(value, decimals) {
          if (!decimals) {
            decimals = false;
          }
          if (this._emptyValue(value)) {
            return null;
          }
          value = this._getFloatNrStr(value);
          var floatVal = parseFloat(value);
          if (isNaN(floatVal)) {
            return null;
          }
          if (decimals) {
            return floatVal.toFixed(decimals);  
          }
          return floatVal;
        },
        _applyCurrencyFormat: function(internalValue, oldInternalValue) {
          if (this._emptyValue(internalValue)) {
            return;
          } else {
            if (this._getRealNumberValue(internalValue) === this._getRealNumberValue(oldInternalValue)) {
              return;
            }
          }
          
          this.debounce('_internalValueChange', function() {
            // re-format internal value
            internalValue = this._getFloatNrStr(internalValue);
            var val = this._formatNumber(internalValue);
            this.set('internalValue', val);
            // update real value
            this.set('value', this._getRealNumberValue(internalValue));
            console.log(this.internalValue, this.value);
          }.bind(this), 300);

        },

        _getFloatNrStr: function(value) {
          if (typeof value !== 'string') {
            value += '';
          }
          return value.split(', ').join('');
        },

        _emptyValue: function(value) {
          if (value === null || typeof value === 'undefined') {
            return true;
          }
          value = value + '';
          if (value === '') {
            return true;
          }
          return false;
        }

      });
    })();
  </script>

</dom-module>

